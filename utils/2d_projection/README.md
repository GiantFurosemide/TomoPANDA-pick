# 2D Projection Module

基于球面 Fibonacci 均匀方向采样的 subtomo 多取向投影生成模块。

## 文件结构

- `math_utils.py`: 数学工具模块

  - `fibonacci_sphere_sampling()`: Fibonacci 球面均匀方向采样
  - `direction_to_relion_zyz()`: 方向向量到 RELION ZYZ 欧拉角转换
  - `zyz_euler_to_rotation_matrix()`: ZYZ 欧拉角到旋转矩阵转换
- `projection.py`: 3D 到 2D 投影模块

  - `project_3d_to_2d_rotated()`: 完整的 3D 旋转和投影实现
- `main.py`: 主脚本

  - 读取 YAML 配置
  - 生成投影栈
  - 输出 RELION 3 格式的 star 文件
- `analyze_results.py`: 结果分析脚本

  - `extract_slice_indices_from_star()`: 从 RELION particle star 文件中提取所有的 slice index
  - `extract_lines_by_indices()`: 从 txt 文件中提取指定 index 对应的行
  - `extract_lines_from_star_and_txt()`: 整合功能，从 star 文件提取 indices，然后从 txt 文件提取对应的行
  - `extract_particle_id_from_path()`: 从颗粒路径的basename中提取颗粒ID
  - `extract_particle_ids_from_txt()`: 从txt文件中提取所有颗粒ID
  - `filter_dynamo_tbl_by_particle_ids()`: 从Dynamo tbl文件中提取指定颗粒ID对应的行
  - `extract_tbl_by_particle_txt()`: 整合功能，从txt文件提取颗粒ID，然后从tbl文件提取对应的行
- `example_config.yaml`: 示例配置文件

## 使用方法

### 生成2D投影

```bash
# for single useage
python utils/2d_projection/main.py -i config.yaml
```

### 分析投影结果

`analyze_results.py` 提供了从 particle star 文件中提取 slice index，以及从 txt 文件中提取指定行的功能。

#### Python API 使用

```python
from utils.2d_projection.analyze_results import (
    extract_slice_indices_from_star,
    extract_lines_by_indices,
    extract_lines_from_star_and_txt
)

# 方法1：只提取indices并保存到文件（0-based）
indices = extract_slice_indices_from_star("particles.star", "indices.txt")

# 方法2：从txt文件提取指定行（使用1-based indices，与star文件对应）
lines = extract_lines_by_indices("subtomos.txt", [1, 3, 5], "output.txt")

# 方法3：从txt文件提取指定行（使用0-based indices）
lines = extract_lines_by_indices("subtomos.txt", [0, 2, 4], "output.txt", indices_are_0based=True)

# 方法4：整合功能 - 从star提取indices，然后从txt提取对应行
lines = extract_lines_from_star_and_txt(
    "particles.star",
    "subtomos.txt", 
    "extracted_lines.txt",
    "indices.txt"  # 可选：保存0-based indices
)
```

#### 命令行使用

```bash
# 从star文件提取indices并保存（0-based）
python utils/2d_projection/analyze_results.py -s particles.star --index-file indices.txt

# 整合功能：从star和txt提取行
python utils/2d_projection/analyze_results.py -s particles.star -t subtomos.txt -o output.txt --index-file indices.txt

# 从txt文件提取指定行（使用1-based indices）
python utils/2d_projection/analyze_results.py -t subtomos.txt -i 1 3 5 -o output.txt

# 从txt文件提取指定行（使用0-based indices）
python utils/2d_projection/analyze_results.py -t subtomos.txt -i 0 2 4 -o output.txt --zero-based

# 从txt文件提取颗粒ID，然后从tbl文件提取对应的行
python utils/2d_projection/analyze_results.py --extract-tbl-by-txt -t particles.txt --tbl all_particles.tbl --output-tbl filtered_particles.tbl
```

#### 从颗粒路径提取ID并过滤tbl文件

```python
from utils.2d_projection.analyze_results import (
    extract_particle_ids_from_txt,
    filter_dynamo_tbl_by_particle_ids,
    extract_tbl_by_particle_txt
)

# 方法1：从txt文件提取颗粒ID
particle_ids = extract_particle_ids_from_txt("particles.txt")
# 颗粒路径格式：particle_035948.mrc -> 提取出 35948（去掉前导零）

# 方法2：从tbl文件提取指定颗粒ID的行
filtered_df = filter_dynamo_tbl_by_particle_ids(
    "all_particles.tbl",
    [35948, 1234, 5678],
    "filtered_particles.tbl"
)

# 方法3：整合功能 - 从txt提取颗粒ID，然后从tbl提取对应行
filtered_df = extract_tbl_by_particle_txt(
    "particles.txt",
    "all_particles.tbl",
    "filtered_particles.tbl"
)
```

**注意事项：**
- star 文件中的 slice index（`n@x.mrcs` 中的 `n`）是从 1 开始的（1-based）
- 保存到 txt 文件的 indices 会自动转换为 0-based（n-1）
- 从 txt 文件读取行时，默认使用 1-based indices（与 star 文件对应）
- 如果使用 `--zero-based` 参数，则使用 0-based indices
- 颗粒路径格式应为：`particle_035948.mrc`（particle_前缀 + 数字ID + 扩展名）
- 颗粒ID会自动去掉前导零（如035948 -> 35948）
- tbl 文件的第一列（tag列）必须是颗粒ID

## full workflow

### 1. files&env you need(copy this files into you project's dir)

1. conda env tomopanda
2. TomoPanda-pick repository: we will use this path to find executive python file.
3. utils/2d_projection/convert_em2mrc.m: matlab function to convert subtomo em file(from dynamo) to contrast inversed mrc file
4. utils/2d_projection/example_config.yaml: copy as config.yaml first. All parameter for 2d projection, edit this before use.
5. utils/2d_projection/tomopanda-pick_relion.sbatch: use relion_image_handler to reformat mrc file generated by dynamo, and set angpix.
6. utils/2d_projection/tomopanda-pick_2d_projection.sbatch: to generate 2d projections for relion&cryosparc.

### 2. Detailed workflow

1. go to PROJECT_ROOT, with dynamo particle fold(for example, DYNAMO_PARTICLE_DIR).
2. cp convert_em2mrc.m here
3. open matlab, initiate dynamo env.
4. in matlab console, run 'convert_em2mrc('$DYNAMO_PARTICLE_DIR')'
5. use 'find' to generate all path to mrc file and ave as 'subtomos.txt'
6. after finish convertion, edit and sbatch tomopanda-pick_relion.sbatch to reformat mrc files into correct format. It will read 'subtomos.txt'.
7. edit config.yaml and tomopanda-pick_2d_projection.sbatch

## 配置文件格式

参见 `example_config.yaml` 文件。

## 输出结构

```
output_root/
  config_resolved.yaml
  orientations.tsv
  index_particles.tsv
  particles.star
  ori_000/
    proj_ori_000.mrcs
    index_ori_000.tsv
  ori_001/
    proj_ori_001.mrcs
    index_ori_001.tsv
  ...
```

## 依赖

- numpy
- scipy
- pandas
- mrcfile
- starfile
- pyyaml
- tqdm

所有依赖都在项目的 `requirements.txt` 中。
