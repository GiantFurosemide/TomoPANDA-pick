# 2D Projection Module

基于球面 Fibonacci 均匀方向采样的 subtomo 多取向投影生成模块。

## 文件结构

- `math_utils.py`: 数学工具模块

  - `fibonacci_sphere_sampling()`: Fibonacci 球面均匀方向采样
  - `direction_to_relion_zyz()`: 方向向量到 RELION ZYZ 欧拉角转换
  - `zyz_euler_to_rotation_matrix()`: ZYZ 欧拉角到旋转矩阵转换
- `projection.py`: 3D 到 2D 投影模块

  - `project_3d_to_2d_rotated()`: 完整的 3D 旋转和投影实现
- `main.py`: 主脚本

  - 读取 YAML 配置
  - 生成投影栈
  - 输出 RELION 3 格式的 star 文件
- `analyze_results.py`: 结果分析脚本（完整流程处理）

  - `process_star_txt_tbl()`: 完整流程整合功能
    - 从star文件提取slice indices
    - 从particle txt文件提取对应的行
    - 从提取的particle txt中提取颗粒ID
    - 从Dynamo tbl文件中提取对应的行
    - 所有结果保存到输出目录
- `example_config.yaml`: 示例配置文件

## 使用方法

### 将EM格式的subtomo转换为mrc格式

拷贝covert_em2mrc至dynamo所在的文件夹

并在dynamo的matlab console中运行

```matlab
convert_em2mrc('/path/to/particle_data')
```

### 生成subtomos.txt

用 find 命令将 准换好的mrc 文件保存在 subtomos.txt 中

```bash
find $pwd -name "*.mrc" | sort > subtomos.txt
```


### relion 处理，修正mrc header

用relion_image_handler修正mrc 的header。拷贝tomopanda-pick_relion.sbatch至当前文件夹。

edit其中参数LIST_FILE、PIXEL_SIZE、NPROC。

提交sbatch 至集群运行

### 生成2D投影

```bash
# 1. edit config.yaml file before starting

## 2.1 for single useage
python utils/2d_projection/main.py -i config.yaml

## 2.2 for cluster
sbatch tomopanda-pick_2d_projection.sbatch 
```

### 分析投影结果

`analyze_results.py` 提供完整流程处理：从star文件提取slice indices，从particle txt提取对应行，提取颗粒ID，从tbl提取对应行。

#### 命令行使用

```bash
python utils/2d_projection/analyze_results.py \
    -s particles.star \
    -t particles.txt \
    --tbl all_particles.tbl \
    --output-dir output_dir
```

#### 使用bash脚本（推荐）

```bash
# 使用bash脚本执行完整流程
# bash analyze_results.sh <star_file> <particle_txt> <tbl_file> <output_dir>
bash utils/2d_projection/analyze_results.sh \
    particles.star \
    particles.txt \
    all_particles.tbl \
    output_dir
```

#### Python API 使用

```python
from utils.2d_projection.analyze_results import process_star_txt_tbl

result = process_star_txt_tbl(
    "particles.star",      # 输入的star文件
    "particles.txt",       # 输入的particle txt文件
    "all_particles.tbl",   # 输入的Dynamo tbl文件
    "output_dir"           # 输出目录
)
```

**输出文件（在output_dir目录中）：**

- `index.txt`: 0-based的slice indices
- `particles.processed.txt`: 处理后的particle txt文件（根据star文件中的indices提取）
- `all_particles.processed.tbl`: 处理后的tbl文件（根据提取的颗粒ID过滤）

**注意事项：**

- star 文件中的 slice index（`n@x.mrcs` 中的 `n`）是从 1 开始的（1-based）
- 保存到 txt 文件的 indices 会自动转换为 0-based（n-1）
- 从 txt 文件读取行时，默认使用 1-based indices（与 star 文件对应）
- 如果使用 `--zero-based` 参数，则使用 0-based indices
- 颗粒路径格式应为：`particle_035948.mrc`（particle_前缀 + 数字ID + 扩展名）
- 颗粒ID会自动去掉前导零（如035948 -> 35948）
- tbl 文件的第一列（tag列）必须是颗粒ID

## full workflow

### 1. files&env you need(copy this files into you project's dir)

1. conda env tomopanda
2. TomoPanda-pick repository: we will use this path to find executive python file.
3. utils/2d_projection/convert_em2mrc.m: matlab function to convert subtomo em file(from dynamo) to contrast inversed mrc file
4. utils/2d_projection/example_config.yaml: copy as config.yaml first. All parameter for 2d projection, edit this before use.
5. utils/2d_projection/tomopanda-pick_relion.sbatch: use relion_image_handler to reformat mrc file generated by dynamo, and set angpix.
6. utils/2d_projection/tomopanda-pick_2d_projection.sbatch: to generate 2d projections for relion&cryosparc.

### 2. Detailed workflow

1. go to PROJECT_ROOT, with dynamo particle fold(for example, DYNAMO_PARTICLE_DIR).
2. cp convert_em2mrc.m here
3. open matlab, initiate dynamo env.
4. in matlab console, run 'convert_em2mrc('$DYNAMO_PARTICLE_DIR')'
5. use 'find' to generate all path to mrc file and ave as 'subtomos.txt'
6. after finish convertion, edit and sbatch tomopanda-pick_relion.sbatch to reformat mrc files into correct format. It will read 'subtomos.txt'.
7. edit config.yaml and tomopanda-pick_2d_projection.sbatch

## 配置文件格式

参见 `example_config.yaml` 文件。

## 输出结构

```
output_root/
  config_resolved.yaml
  orientations.tsv
  index_particles.tsv
  particles.star
  ori_000/
    proj_ori_000.mrcs
    index_ori_000.tsv
  ori_001/
    proj_ori_001.mrcs
    index_ori_001.tsv
  ...
```

## 依赖

- numpy
- scipy
- pandas
- mrcfile
- starfile
- pyyaml
- tqdm

所有依赖都在项目的 `requirements.txt` 中。
